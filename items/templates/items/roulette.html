{% extends 'items/base.html' %}
{% load static %}

{% block title %}Roulette - Nowpad{% endblock %}
{% block window_title %}ðŸŽ² Roulette{% endblock %}

{% block content %}
{% csrf_token %}
<div class="roulette-page">
    <!-- Filters -->
    <form method="get" class="roulette-filters" id="roulette-form">
        <div class="filters-row">
            <div class="filter-group">
                <label class="win95-label">Type</label>
                <select name="type" multiple class="multi-select" size="4">
                    {% for value, label in type_choices %}
                    {% if value %}
                    <option value="{{ value }}" {% if value in current_types %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="win95-label">Time Frame</label>
                <select name="time_frame" multiple class="multi-select" size="5">
                    {% for value, label in time_frame_choices %}
                    {% if value %}
                    <option value="{{ value }}" {% if value in current_time_frames %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="win95-label">Action Length</label>
                <select name="action_length" multiple class="multi-select" size="4">
                    {% for value, label in action_length_choices %}
                    {% if value %}
                    <option value="{{ value }}" {% if value in current_action_lengths %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filters-row">
            <div class="filter-group">
                <label class="win95-label">Value (min)</label>
                <select name="value_min" class="win95-select">
                    <option value="">â€”</option>
                    {% for val, label in rating_choices %}
                    {% if val %}
                    <option value="{{ val }}" {% if current_value_min == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="win95-label">Value (max)</label>
                <select name="value_max" class="win95-select">
                    <option value="">â€”</option>
                    {% for val, label in rating_choices %}
                    {% if val %}
                    <option value="{{ val }}" {% if current_value_max == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="win95-label">Difficulty (min)</label>
                <select name="difficulty_min" class="win95-select">
                    <option value="">â€”</option>
                    {% for val, label in rating_choices %}
                    {% if val %}
                    <option value="{{ val }}" {% if current_difficulty_min == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="win95-label">Difficulty (max)</label>
                <select name="difficulty_max" class="win95-select">
                    <option value="">â€”</option>
                    {% for val, label in rating_choices %}
                    {% if val %}
                    <option value="{{ val }}" {% if current_difficulty_max == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="roll-section">
            <div class="matching-count">
                <span class="count-number">{{ matching_count }}</span> matching items
            </div>
            <button type="submit" name="roll" value="1" class="win95-btn win95-btn-primary roll-btn" {% if matching_count == 0 %}disabled{% endif %}>
                ðŸŽ² Roll
            </button>
        </div>
    </form>
    
    <!-- Result -->
    <div class="roulette-result">
        {% if did_roll %}
            {% if selected_item %}
            <div class="result-card" id="result-card" data-item-id="{{ selected_item.id }}">
                <div class="result-header">âœ¨ Your random pick:</div>
                <div class="result-note">{{ selected_item.note }}</div>
                <div class="result-meta">
                    {% if selected_item.type %}<span class="meta-tag">{{ selected_item.type }}</span>{% endif %}
                    {% if selected_item.action_length %}<span class="meta-tag">{{ selected_item.action_length }}</span>{% endif %}
                    {% if selected_item.time_frame %}<span class="meta-tag">{{ selected_item.time_frame }}</span>{% endif %}
                    {% if selected_item.value %}<span class="meta-tag">Value: {{ selected_item.value }}</span>{% endif %}
                    {% if selected_item.difficulty %}<span class="meta-tag">Diff: {{ selected_item.difficulty }}</span>{% endif %}
                    {% if selected_item.life_category %}<span class="meta-tag">{{ selected_item.life_category.name }}</span>{% endif %}
                </div>
                <div class="result-actions">
                    <button type="button" class="win95-btn win95-btn-primary complete-btn" onclick="markComplete({{ selected_item.id }})">
                        âœ“ Mark Completed
                    </button>
                </div>
            </div>
            {% else %}
            <div class="result-empty">
                No matching items found. Try adjusting your filters.
            </div>
            {% endif %}
        {% else %}
        <div class="result-placeholder">
            Set your filters and click <strong>Roll</strong> to pick a random task!
        </div>
        {% endif %}
    </div>
</div>

<script>
function markComplete(itemId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/x9K3pQ7v2/api/item/${itemId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: 'status',
            value: 'Complete'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const card = document.getElementById('result-card');
            card.classList.add('completed');
            card.innerHTML = `
                <div class="result-header">âœ… Completed!</div>
                <div class="result-note">${data.item.note}</div>
                <div class="completed-message">Great job! This item has been marked as complete.</div>
            `;
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error marking item complete');
        console.error(error);
    });
}
</script>

<style>
.roulette-page {
    max-width: 800px;
    margin: 0 auto;
}

.roulette-filters {
    background: var(--win95-gray-light);
    box-shadow: var(--win95-border-sunken);
    padding: 16px;
    margin-bottom: 20px;
}

.filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
    align-items: flex-end;
}

.filters-row .filter-group {
    flex: 1;
    min-width: 120px;
}

.roll-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 12px;
    border-top: 1px solid var(--win95-gray);
    margin-top: 8px;
}

.matching-count {
    font-size: 14px;
    color: var(--win95-gray-darker);
}

.count-number {
    font-weight: bold;
    font-size: 18px;
    color: var(--win95-black);
}

.roll-btn {
    padding: 12px 32px;
    font-size: 16px;
    font-weight: bold;
}

.roll-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.roulette-result {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.result-placeholder {
    text-align: center;
    color: var(--win95-gray-dark);
    font-size: 15px;
    padding: 40px;
}

.result-empty {
    text-align: center;
    color: #aa0000;
    font-size: 15px;
    padding: 40px;
    background: #ffeeee;
    box-shadow: var(--win95-border-sunken);
    width: 100%;
}

.result-card {
    background: var(--win95-white);
    box-shadow: var(--win95-border-raised);
    padding: 20px;
    width: 100%;
    animation: pop-in 0.3s ease-out;
}

.result-card.completed {
    background: #e8ffe8;
}

@keyframes pop-in {
    0% { transform: scale(0.9); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}

.result-header {
    font-size: 13px;
    color: var(--win95-gray-dark);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.result-note {
    font-size: 18px;
    line-height: 1.5;
    padding: 16px;
    background: var(--win95-gray-light);
    box-shadow: var(--win95-border-sunken);
    margin-bottom: 16px;
    white-space: pre-wrap;
}

.result-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.meta-tag {
    background: var(--win95-gray);
    box-shadow: var(--win95-border-raised);
    padding: 4px 10px;
    font-size: 12px;
}

.result-actions {
    padding-top: 16px;
    border-top: 1px solid var(--win95-gray);
}

.complete-btn {
    padding: 10px 24px;
    font-size: 14px;
    font-weight: bold;
    background: #90EE90;
}

.complete-btn:hover {
    background: #7CDC7C;
}

.completed-message {
    color: #006600;
    font-size: 14px;
    padding: 12px;
    background: #d4ffd4;
    box-shadow: var(--win95-border-sunken);
    text-align: center;
}

@media (max-width: 480px) {
    .filters-row {
        flex-direction: column;
    }
    
    .roll-section {
        flex-direction: column;
        gap: 12px;
    }
    
    .roll-btn {
        width: 100%;
    }
    
    .complete-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

